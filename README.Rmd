---
output: github_document
date: "`r Sys.time()`."
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  config_general = "man/figures/README-",
  out.width = "100%",
  cache = TRUE
)

devtools::load_all()
```

# PACTA_analysis

The goal of this repository is to assess how well a porfolio aligns with climate
goals. 

This documents targets internal 2DII users and developers. It provides
reproducible examples of what you can achieve with the code in this repository
and friends. You may use it as a guide to run your own analyses, or as an
integration test to ensure code changes preserve the behaviour documented here.
Readers outside 2DII may instead see other related work:
[transitionmonitor.com](https://platform.transitionmonitor.com/start),
[r2dii.data](https://github.com/2DegreesInvesting/r2dii.data),
[r2dii.match](https://github.com/2DegreesInvesting/r2dii.match), and
[r2dii.analysis](https://github.com/2DegreesInvesting/r2dii.analysis).

You may want to analyze a single portfolio and investor, or multiple ones. This document details two workflows:

* __Single-inputs workflow__: When the number of portfolios and investors is
exactly one, we use a specific set of scripts optimized for this purpose. This
workflow is typically used to generate interactive reports. Because this
workflow is available [online](https://platform.transitionmonitor.com/start), it
has been referred to as "the online workflow", and the scripts as "the web tool
scripts". This is misleading because this workflow can run offline too.
* __Multiple-outputs workflow__: When the number of portfolios and/or investors
is not exactly one, we use a different set of optimized scripts. This workflow
is typically used to produce static (.pdf) reports. By contrast with the
so-called "online" workflow, this one has been usually referred to as "the
offline workflow"; again, this is misleading.

Both workflows include three steps:

1. Clean portfolio: Clean the input portfolio and merge in financial data, to
categorize each holding and identify whether it's equity (EQ) or corporate bonds
(CB).
2. Run Analysis: Merge portfolios with asset-level data and scenarios, then
group results at company, portfolio and regional level.
3. Present results: Present the results in a clear output format.

--

Note that "`$`" and "`#>`" precede bash and R output, respectively.

## Setup

Let's start by loading the packages we use in this file. Notice we `load_all()`
features in the PACTA.analysis package, which lives inside the PACTA_analysis
repository.

```{r, packages}
library(devtools, warn.conflicts = FALSE)
load_all()
```

These helpers are for this document only:

```{r child="helpers.Rmd"}

```

## Siblings

```{r include=FALSE}
siblings <- list.files(
  "..",pattern = "[.]pacta$", recursive = TRUE, all.files = TRUE
)
siblings <- basename(dirname(siblings))
writeLines(siblings)
```

The PACTA family includes these siblings: `r siblings`. They are all available
at <https://github.com/2DegreesInvesting> and some workflows assume they all
live directly under the same parent directory. Before running a workflow, you
may pull the latest commits of the relevant siblings from Github, to ensure the
code you use is up to date.

## Computing environment

The docker image [rocker/verse](https://hub.docker.com/r/rocker/verse) provides
most of what you need for a functional computing environment, including system
dependencies, a bash terminal and RStudio. The image
[2dii/pacta_analysis](https://hub.docker.com/r/2dii/pacta_analysis) extends
rocker/verse to include the required R packages. Here it its Dockerfile:

```{r echo=FALSE, comment=""}
look_into("Dockerfile")
```

Finally you need access to the PACTA [siblings](#Siblings). You can
create one or more volumes mapping the location of the siblings from your (host)
computer to the container. 

Here are two ways to access a full computing environment, including PACTA
siblings:

* To work from with RStudio, ensure your working directory is PACTA_analysis/,
then run `docker-compose up`. RStudio is now available from your a browser at
http://localhost:8787, with some personal configuration files and all siblings
available at the home directory of the container. When you are finished using
this service, run `docker-compose down`. The details of this environment are
described in the file docker-compose.yml:

```{r echo=FALSE, comment=""}
look_into("docker-compose.yml")
```

* To work from an interactive terminal, ensure your working directory is the
parent of all PACTA siblings, then run `docker run --rm -ti -v "$(pwd):/root"
2dii/pacta_analysis:latest bash`. You are now into an ephemeral (`--rm`) docker
container running an interactive `bash` terminal (`-it`) mapping (`-v`) the
parent directory of all PACTA siblings to the /root directory.

To prove this environment works, I used this environment to render the very
document you are now reading with `devtools::build_readme()`.

<details> <summary>Session information.</summary>
```{r}
devtools::session_info()
```
</details>

--

Reference:

* [2DegreesInvesting/docker](https://github.com/2DegreesInvesting/docker/tree/master/r-packages).
* [Install Docker](https://docs.docker.com/engine/install/).
* [Install docker-compose](https://docs.docker.com/compose/install/).

## Reproducible examples of PACTA workflows

This section shows reproducible examples of both the single- and multiple-inputs
workflows. You may use these examples in at least three ways:

* Read this document for an overview of which workflows are possible.
* Run them on your local computer to track and explore their implementation.
* Run them on a server as an integration test.

### Single-inputs workflow

TODO: Document inputs/outputs

> There's a pretty important absence here... any explanation of where the critically important input files are or need to be. Hypothetically, the repo should work because it includes some default example files, but any analyst truly using this repo... the first thing they would want to do is put their input files in working_dir -- CJ

The single-inputs workflow is composed of multiple steps, each in its own
script: `r list.files(pattern = "web_tool_script")`.

In R you can run each script individually with something like
`source("web_tool_script_1.R")` or run multiple scripts at once with:

```{r}
# Helper from the package PACTA.analysis
source_web_tool_scripts()
```

In a terminal you can run each script individually, e.g. "web_tool_script_1.R",
with:

```{bash comment="$", error=TRUE}
Rscript --vanilla web_tool_script_1.R TestPortfolio_Input  
```

### Multiple-inputs workflow

```{r child="workflow-multiple-inputs.Rmd"}

```

